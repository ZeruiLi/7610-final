<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Restaurant Recommender (MVP)</title>
    <style>
      /* Xiaohongshu-like light card waterfall layout */
      :root {
        --bg:#f6f7fb; --card:#ffffff; --txt:#0b1020; --muted:#667085; --accent:#ff2e4d; --border:#eee; --chip:#f1f5f9;
      }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial; margin:0; background:var(--bg); color:var(--txt); }
      .shell { position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(246,247,251,.95), rgba(246,247,251,.75)); backdrop-filter: blur(6px); border-bottom:1px solid var(--border); }
      .nav { max-width: 1200px; margin: 0 auto; padding: 12px 16px; display:flex; align-items:center; gap:12px; }
      .brand { font-weight:700; letter-spacing:.2px; }
      .searchbar { flex:1; display:flex; gap:8px; }
      .input { flex:1; border:1px solid var(--border); background:#fff; border-radius:999px; padding:10px 14px; font-size:14px; }
      .btn { padding:10px 16px; border-radius:999px; border:0; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; box-shadow:0 8px 20px rgba(255,46,77,.25); }

      .wrap { max-width:1200px; margin:0 auto; padding:16px; }
      .two { display:grid; grid-template-columns: 1fr 1.1fr; gap:16px; }
      @media (max-width: 960px){ .two{ grid-template-columns:1fr; } }

      /* left report card */
      .card { background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(16,24,40,.04); }
      .card .hd { padding:14px 16px; border-bottom:1px solid var(--border); font-weight:600; }
      .card .bd { padding:16px; }
      .md { line-height:1.6; }

      /* right waterfall feed */
      .waterfall { column-count: 3; column-gap: 16px; }
      @media (max-width: 1200px){ .waterfall { column-count: 2; } }
      @media (max-width: 640px){ .waterfall { column-count: 1; } }
      .post { break-inside: avoid; margin: 0 0 16px 0; background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(16,24,40,.06); overflow:hidden; }
      .post .ph { height: 140px; background:linear-gradient(135deg, #f9fafb, #eef2f7); display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:12px; }
      .post .ct { padding: 12px 14px 14px 14px; }
      .row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
      .title { font-weight:700; letter-spacing:.2px; margin:0; }
      .score { background:#10b981; color:#053d2d; font-weight:700; padding:2px 8px; border-radius:999px; font-size:12px; }
      .addr { color:var(--muted); font-size:12px; margin-top:4px; }
      .chips { margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; }
      .chip { background:var(--chip); border-radius:999px; padding:4px 8px; font-size:12px; color:#0b1020; border:1px solid var(--border); }
      .dishes { margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; }
      .dish { background:#fff1f3; color:#9f1239; border:1px solid #ffe4e9; border-radius:999px; padding:3px 8px; font-size:12px; }
      .reason { margin-top:8px; font-size:13px; color:#0f172a; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient: vertical; overflow:hidden; }
      .toggle { color:var(--accent); cursor:pointer; font-size:12px; margin-top:4px; display:inline-block; }
      .links { margin-top:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
      .link { color:var(--accent); text-decoration:none; font-size:12px; }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="nav">
        <div class="brand">üçú Recommender</div>
        <div class="searchbar">
          <input id="query" class="input" placeholder="ÊèèËø∞‰Ω†ÁöÑÂ∞±È§êÈúÄÊ±ÇÔºàÁ§∫‰æãÔºöSeattle U‚ÄëDistrictÔºå2 peopleÔºå$30/ppÔºåJapaneseÔºåquietÔºâ"/>
          <button id="runBtn" class="btn">Recommend</button>
        </div>
        <span id="status" class="muted small"></span>
      </div>
    </div>

    <div class="wrap">
      <div class="two">
        <div class="card">
          <div class="hd">Report</div>
          <div class="bd"><div class="md" id="report">‚Äî</div></div>
        </div>
        <div>
          <div class="waterfall" id="cards"></div>
        </div>
      </div>
    </div>

    <script>
      const q = document.getElementById('query');
      q.value = 'Dinner around Seattle U-District, 2 people, budget $30 per person, Japanese cuisine, quiet environment';

      const statusEl = document.getElementById('status');
      const reportEl = document.getElementById('report');
      const cardsEl = document.getElementById('cards');

      // Markdown renderer (CDN)
      const mdScript = document.createElement('script');
      mdScript.src = 'https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js';
      document.head.appendChild(mdScript);

      function haversineKm(lat1, lon1, lat2, lon2){
        const R = 6371;
        const toRad = (d)=>d*Math.PI/180;
        const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
        return 2*R*Math.asin(Math.sqrt(a));
      }

      async function run() {
        const payload = { query: q.value.trim() };
        if (!payload.query) {
          alert('Please enter your dining requirements.');
          return;
        }
        statusEl.textContent = 'Requesting recommendations‚Ä¶';
        reportEl.textContent = '‚Ä¶';
        cardsEl.innerHTML = '';
        try {
          const resp = await fetch('/recommend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(text || ('HTTP ' + resp.status));
          }
          const data = await resp.json();
          // render report markdown
          const md = (window.markdownit && window.markdownit()) || null;
          reportEl.innerHTML = md ? md.render(data.recommendations_markdown || '') : `<pre>${data.recommendations_markdown || ''}</pre>`;

          const bbox = data.bbox || [0,0,0,0];
          const centerLon = (bbox[0]+bbox[2])/2, centerLat = (bbox[1]+bbox[3])/2;

          (data.candidates || []).forEach((c, i) => {
            const km = haversineKm(centerLat, centerLon, c.place.lat, c.place.lon);
            const div = document.createElement('div');
            div.className = 'post';
            div.innerHTML = `
              <div class="ph">Photo / Map</div>
              <div class="ct">
                <div class="row">
                  <h3 class="title">${c.place.name}</h3>
                  <span class="score">${c.score.toFixed(3)}</span>
                </div>
                <div class="addr">${c.place.address || ''} ¬∑ ${km.toFixed(1)} km</div>
                <div class="chips">
                  ${c.match_cuisine ? '<span class="chip">Cuisine‚úì</span>' : ''}
                  ${c.match_ambience ? '<span class="chip">Ambience‚úì</span>' : ''}
                  ${c.match_distance ? '<span class="chip">‚â§dist</span>' : ''}
                  ${c.match_budget ? '<span class="chip">Budget‚úì</span>' : ''}
                </div>
                <div class="dishes">${(c.signature_dishes||[]).map(d=>`<span class='dish'>${d}</span>`).join('')}</div>
                <div class="reason" data-full="${encodeURIComponent(((c.highlights||[]).concat(c.why_matched||[])).join('\n'))}">
                  ${((c.highlights||[]).concat(c.why_matched||[])).map(x=>`‚Ä¢ ${x}`).join('<br/>') || c.reason || ''}
                </div>
                <a class="toggle" href="#">Â±ïÂºÄ/Êî∂Ëµ∑</a>
                <div class="links">
                  <a class="link" href="${c.place.datasource_url || '#'}" target="_blank">Âú®Âú∞Âõæ‰∏≠ÊâìÂºÄ</a>
                  ${(c.detail_sources||[]).map(s=>`<a class='link' href='${s.url}' target='_blank'>${s.title}</a>`).join('')}
                </div>
              </div>
            `;
            const toggle = div.querySelector('.toggle');
            const reason = div.querySelector('.reason');
            toggle.addEventListener('click', (e)=>{
              e.preventDefault();
              if (reason.style.webkitLineClamp === 'unset'){
                reason.style.webkitLineClamp = '3';
              } else {
                reason.style.webkitLineClamp = 'unset';
              }
            });
            cardsEl.appendChild(div);
          });
          statusEl.textContent = 'Done.';
        } catch (e) {
          statusEl.textContent = 'Error';
          reportEl.textContent = String(e);
        }
      }
      document.getElementById('runBtn').addEventListener('click', run);
    </script>
  </body>
  </html>
